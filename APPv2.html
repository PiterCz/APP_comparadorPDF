<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comparador de Informes de Medicaci√≥n</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        /* Stats Cards */
        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 10px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #666;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .stat-card.new { border-left: 4px solid #10b981; }
        .stat-card.new .stat-number { color: #10b981; }
        
        .stat-card.removed { border-left: 4px solid #ef4444; }
        .stat-card.removed .stat-number { color: #ef4444; }
        
        .stat-card.modified { border-left: 4px solid #3b82f6; }
        .stat-card.modified .stat-number { color: #3b82f6; }

        /* Main Content */
        .main-content {
            background: white;
            border-radius: 10px;
            padding: 30px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        /* Tabs */
        .tabs {
            display: flex;
            border-bottom: 2px solid #e5e7eb;
            margin-bottom: 30px;
        }

        .tab {
            padding: 12px 24px;
            cursor: pointer;
            border: none;
            background: none;
            font-size: 1rem;
            color: #666;
            transition: all 0.3s;
            position: relative;
        }

        .tab:hover {
            color: #667eea;
        }

        .tab.active {
            color: #667eea;
            font-weight: 600;
        }

        .tab.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            right: 0;
            height: 2px;
            background: #667eea;
        }

        /* Changes Section */
        .changes-section {
            display: none;
        }

        .changes-section.active {
            display: block;
        }

        /* Category Sections */
        .category-section {
            margin-bottom: 30px;
        }

        .category-header {
            background: #f3f4f6;
            padding: 12px 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            color: #374151;
        }

        .category-icon {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
        }

        .category-icon.new { background: #10b981; }
        .category-icon.removed { background: #ef4444; }
        .category-icon.dosage { background: #3b82f6; }
        .category-icon.observation { background: #f59e0b; }

        .medication-change {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            margin-bottom: 20px;
            overflow: hidden;
            transition: all 0.3s;
        }

        .medication-change:hover {
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .medication-header {
            background: #f9fafb;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .medication-name {
            font-weight: 600;
            font-size: 1.1rem;
            color: #1f2937;
        }

        .change-type {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            text-transform: uppercase;
        }

        .change-type.new {
            background: #d1fae5;
            color: #065f46;
        }

        .change-type.removed {
            background: #fee2e2;
            color: #991b1b;
        }

        .change-type.modified {
            background: #dbeafe;
            color: #1e40af;
        }

        .medication-details {
            padding: 20px;
            background: #fafafa;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            background: white;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .detail-label {
            font-size: 0.85rem;
            color: #6b7280;
            margin-bottom: 4px;
        }

        .detail-value {
            font-weight: 500;
            color: #1f2937;
        }

        .change-description {
            background: #f3f4f6;
            padding: 15px;
            border-radius: 6px;
            margin-top: 15px;
        }

        .change-description h4 {
            color: #374151;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .change-item {
            margin: 5px 0;
            padding: 5px 0;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .change-icon {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: white;
            font-size: 14px;
        }

        .change-icon.add { background: #10b981; }
        .change-icon.remove { background: #ef4444; }
        .change-icon.modify { background: #3b82f6; }

        /* Report Section */
        .report-section {
            background: #f9fafb;
            padding: 25px;
            border-radius: 8px;
            margin-top: 30px;
        }

        .report-section h3 {
            color: #1f2937;
            margin-bottom: 20px;
            font-size: 1.3rem;
        }

        .report-content {
            background: white;
            padding: 20px;
            border-radius: 6px;
            border: 1px solid #e5e7eb;
        }

        .report-item {
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e5e7eb;
        }

        .report-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        /* Button Styles */
        .download-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-top: 20px;
        }

        .download-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .download-button:active {
            transform: translateY(0);
        }

        .download-button svg {
            width: 20px;
            height: 20px;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
            }

            .header {
                background: none;
                color: black;
                border: 2px solid #333;
            }

            .no-print {
                display: none;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 1.8rem;
            }

            .stats-container {
                grid-template-columns: 1fr 1fr;
            }

            .detail-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Loading */
        .loading {
            text-align: center;
            padding: 50px;
            color: #666;
        }

        .loading-spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 50px;
            color: #9ca3af;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin: 0 auto 20px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üìã Comparador de Informes de Medicaci√≥n</h1>
            <p id="patientName" style="font-size: 1.3rem; font-weight: 600; margin: 10px 0;">Paciente: <span id="patientNameText">No especificado</span></p>
            <p id="comparisonInfo">Comparando archivos PDF</p>
        </div>

        <!-- Statistics -->
        <div class="stats-container">
            <div class="stat-card new">
                <div class="stat-number" id="newMeds">0</div>
                <div class="stat-label">Medicamentos Nuevos</div>
            </div>
            <div class="stat-card removed">
                <div class="stat-number" id="removedMeds">0</div>
                <div class="stat-label">Medicamentos Eliminados</div>
            </div>
            <div class="stat-card modified">
                <div class="stat-number" id="modifiedMeds">0</div>
                <div class="stat-label">Medicamentos Modificados</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalMeds">0</div>
                <div class="stat-label">Total Medicamentos</div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Tabs -->
            <div class="tabs no-print">
                <button class="tab active" onclick="switchTab('changes')">Cambios Detallados</button>
                <button class="tab" onclick="switchTab('summary')">Resumen</button>
                <button class="tab" onclick="switchTab('report')">Informe</button>
            </div>

            <!-- Changes Section -->
            <div id="changes" class="changes-section active">
                <div id="changesContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Cargando cambios...</p>
                    </div>
                </div>
            </div>

            <!-- Summary Section -->
            <div id="summary" class="changes-section">
                <div id="summaryContainer">
                    <div class="loading">
                        <div class="loading-spinner"></div>
                        <p>Generando resumen...</p>
                    </div>
                </div>
            </div>

            <!-- Report Section -->
            <div id="report" class="changes-section">
                <div class="report-section">
                    <h3>Informe de Cambios en Medicaci√≥n</h3>
                    <button class="download-button" onclick="downloadPDF()">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                        </svg>
                        Descargar Informe PDF
                    </button>
                    <div class="report-content" id="reportContent">
                        <div class="loading">
                            <div class="loading-spinner"></div>
                            <p>Generando informe...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variable global para almacenar los datos actuales
        let currentData = null;

        // Funci√≥n para cambiar entre tabs
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.changes-section').forEach(section => section.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Funci√≥n para renderizar cambios organizados por categor√≠as
        function renderChanges(changes) {
            const container = document.getElementById('changesContainer');
            
            if (!changes || Object.keys(changes).length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <p>No se encontraron cambios entre los documentos</p>
                    </div>
                `;
                return;
            }

            // Organizar cambios por categor√≠as
            const categories = {
                new: { title: 'Nuevos Medicamentos', icon: '+', changes: [] },
                removed: { title: 'Medicamentos Retirados', icon: '-', changes: [] },
                dosage: { title: 'Cambios de Posolog√≠a', icon: '‚âà', changes: [] },
                observation: { title: 'Observaciones A√±adidas', icon: '!', changes: [] }
            };

            // Clasificar cambios
            if (changes.new) categories.new.changes = changes.new;
            if (changes.removed) categories.removed.changes = changes.removed;
            if (changes.dosage) categories.dosage.changes = changes.dosage;
            if (changes.observation) categories.observation.changes = changes.observation;

            // Renderizar por categor√≠as
            container.innerHTML = Object.entries(categories).map(([type, category]) => {
                if (category.changes.length === 0) return '';
                
                return `
                    <div class="category-section">
                        <div class="category-header">
                            <span class="category-icon ${type}">${category.icon}</span>
                            <span>${category.title} (${category.changes.length})</span>
                        </div>
                        ${category.changes.map(change => `
                            <div class="medication-change">
                                <div class="medication-header">
                                    <span class="medication-name">${change.medication}</span>
                                    <span class="change-type ${type}">${getChangeTypeText(type)}</span>
                                </div>
                                <div class="medication-details">
                                    ${renderChangeDetails(change, type)}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }).join('');
        }

        // Funci√≥n para obtener texto del tipo de cambio
        function getChangeTypeText(type) {
            const types = {
                'new': 'NUEVO',
                'removed': 'RETIRADO',
                'dosage': 'CAMBIO POSOLOG√çA',
                'observation': 'OBSERVACI√ìN'
            };
            return types[type] || type;
        }

        // Funci√≥n para renderizar detalles del cambio
        function renderChangeDetails(change, type) {
            if (type === 'new') {
                return `
                    <div class="detail-grid">
                        ${change.details ? Object.entries(change.details).map(([key, value]) => `
                            <div class="detail-item">
                                <div class="detail-label">${key}</div>
                                <div class="detail-value">${value || '-'}</div>
                            </div>
                        `).join('') : ''}
                    </div>
                    <div class="change-description">
                        <h4>Descripci√≥n:</h4>
                        <div class="change-item">
                            <span class="change-icon add">+</span>
                            <span>Medicamento a√±adido al tratamiento</span>
                        </div>
                    </div>
                `;
            } else if (type === 'removed') {
                return `
                    <div class="change-description">
                        <h4>Descripci√≥n:</h4>
                        <div class="change-item">
                            <span class="change-icon remove">-</span>
                            <span>Medicamento eliminado del tratamiento</span>
                        </div>
                        ${change.lastDetails ? `
                            <div style="margin-top: 10px; padding: 10px; background: #fef2f2; border-radius: 6px;">
                                <strong>√öltima informaci√≥n registrada:</strong><br>
                                ${Object.entries(change.lastDetails).map(([key, value]) => 
                                    `${key}: ${value}`
                                ).join(' | ')}
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (type === 'dosage') {
                return `
                    <div class="change-description">
                        <h4>Cambios en posolog√≠a:</h4>
                        <div class="change-item">
                            <span class="change-icon modify">‚âà</span>
                            <span>${change.description || 'Modificaci√≥n en la pauta de administraci√≥n'}</span>
                        </div>
                        ${change.before && change.after ? `
                            <div style="margin-top: 10px; display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                                <div style="padding: 10px; background: #fef2f2; border-radius: 6px;">
                                    <strong>Antes:</strong><br>${change.before}
                                </div>
                                <div style="padding: 10px; background: #d1fae5; border-radius: 6px;">
                                    <strong>Despu√©s:</strong><br>${change.after}
                                </div>
                            </div>
                        ` : ''}
                    </div>
                `;
            } else if (type === 'observation') {
                return `
                    <div class="change-description">
                        <h4>Observaci√≥n a√±adida:</h4>
                        <div class="change-item">
                            <span class="change-icon" style="background: #f59e0b;">!</span>
                            <span style="font-weight: 500; color: #d97706;">${change.observation}</span>
                        </div>
                    </div>
                `;
            }
            return '';
        }

        // Funci√≥n para generar resumen
        function generateSummary(data) {
            const container = document.getElementById('summaryContainer');
            const changes = data.changes || {};
            
            container.innerHTML = `
                <div class="report-content">
                    <h3>Resumen de Cambios</h3>
                    <div class="report-item">
                        <strong>Fecha de comparaci√≥n:</strong> ${new Date().toLocaleDateString('es-ES')}
                    </div>
                    <div class="report-item">
                        <strong>Medicamentos nuevos:</strong> ${data.stats.new || 0}
                        ${changes.new && changes.new.length > 0 ? `
                            <ul style="margin-top: 10px; margin-left: 20px;">
                                ${changes.new.map(item => `<li>${item.medication}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                    <div class="report-item">
                        <strong>Medicamentos eliminados:</strong> ${data.stats.removed || 0}
                        ${changes.removed && changes.removed.length > 0 ? `
                            <ul style="margin-top: 10px; margin-left: 20px;">
                                ${changes.removed.map(item => `<li>${item.medication}</li>`).join('')}
                            </ul>
                        ` : ''}
                    </div>
                    <div class="report-item">
                        <strong>Medicamentos modificados:</strong> ${data.stats.modified || 0}
                        ${changes.dosage && changes.dosage.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Cambios de posolog√≠a:</strong>
                                <ul style="margin-left: 20px;">
                                    ${changes.dosage.map(item => `<li>${item.medication}: ${item.description || 'Cambio de dosis'}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${changes.observation && changes.observation.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong>Observaciones a√±adidas:</strong>
                                <ul style="margin-left: 20px;">
                                    ${changes.observation.map(item => `<li>${item.medication}: ${item.observation}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `;
        }

        // Funci√≥n para generar informe detallado
        function generateReport(data) {
            const container = document.getElementById('reportContent');
            const date = new Date().toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            const changes = data.changes || {};

            container.innerHTML = `
                <div class="report-item">
                    <h4>INFORME DE CAMBIOS EN MEDICACI√ìN</h4>
                    <p><strong>Fecha:</strong> ${date}</p>
                    <p><strong>Paciente:</strong> ${data.patientName || 'No especificado'}</p>
                    <p><strong>Archivos comparados:</strong> ${data.file1 || 'PDF 1'} vs ${data.file2 || 'PDF 2'}</p>
                </div>

                ${data.stats.new > 0 && changes.new ? `
                    <div class="report-item">
                        <h4>MEDICAMENTOS A√ëADIDOS (${data.stats.new}):</h4>
                        ${changes.new.map(change => `
                            <div style="margin: 10px 0; padding: 10px; background: #f0fdf4; border-left: 3px solid #10b981;">
                                <strong>${change.medication}</strong>
                                ${change.details ? `
                                    <div style="margin-top: 5px; font-size: 0.9rem;">
                                        ${Object.entries(change.details).map(([key, value]) => 
                                            value ? `${key}: ${value}` : ''
                                        ).filter(Boolean).join(' | ')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${data.stats.removed > 0 && changes.removed ? `
                    <div class="report-item">
                        <h4>MEDICAMENTOS ELIMINADOS (${data.stats.removed}):</h4>
                        ${changes.removed.map(change => `
                            <div style="margin: 10px 0; padding: 10px; background: #fef2f2; border-left: 3px solid #ef4444;">
                                <strong>${change.medication}</strong>
                                ${change.lastDetails ? `
                                    <div style="margin-top: 5px; font-size: 0.9rem;">
                                        ${Object.entries(change.lastDetails).map(([key, value]) => 
                                            value ? `${key}: ${value}` : ''
                                        ).filter(Boolean).join(' | ')}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${changes.dosage && changes.dosage.length > 0 ? `
                    <div class="report-item">
                        <h4>CAMBIOS DE POSOLOG√çA (${changes.dosage.length}):</h4>
                        ${changes.dosage.map(change => `
                            <div style="margin: 10px 0; padding: 10px; background: #eff6ff; border-left: 3px solid #3b82f6;">
                                <strong>${change.medication}</strong>
                                <div style="margin-top: 5px; font-size: 0.9rem;">
                                    ${change.description || `Cambio de ${change.before} a ${change.after}`}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                ${changes.observation && changes.observation.length > 0 ? `
                    <div class="report-item">
                        <h4>OBSERVACIONES A√ëADIDAS (${changes.observation.length}):</h4>
                        ${changes.observation.map(change => `
                            <div style="margin: 10px 0; padding: 10px; background: #fef8e7; border-left: 3px solid #f59e0b;">
                                <strong>${change.medication}</strong>
                                <div style="margin-top: 5px; font-size: 0.9rem; font-style: italic;">
                                    "${change.observation}"
                                </div>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}

                <div class="report-item" style="margin-top: 30px; padding-top: 20px; border-top: 2px solid #e5e7eb;">
                    <p><strong>Observaciones:</strong></p>
                    <p style="margin-top: 10px;">Este informe ha sido generado autom√°ticamente mediante la comparaci√≥n de los informes de medicaci√≥n. Se recomienda revisar los cambios con el personal m√©dico responsable.</p>
                </div>
            `;
        }

        // Funci√≥n principal para cargar datos
        function loadComparisonData(data) {
            // Guardar datos en variable global
            currentData = data;
            
            // Actualizar estad√≠sticas
            document.getElementById('newMeds').textContent = data.stats.new || 0;
            document.getElementById('removedMeds').textContent = data.stats.removed || 0;
            document.getElementById('modifiedMeds').textContent = data.stats.modified || 0;
            document.getElementById('totalMeds').textContent = data.stats.total || 0;

            // Actualizar informaci√≥n del header
            if (data.patientName) {
                document.getElementById('patientNameText').textContent = data.patientName;
            }
            if (data.comparisonInfo) {
                document.getElementById('comparisonInfo').textContent = data.comparisonInfo;
            }

            // Renderizar cambios
            renderChanges(data.changes);

            // Generar resumen
            generateSummary(data);

            // Generar informe
            generateReport(data);
        }

        // Datos de ejemplo basados en las im√°genes REALES
        const exampleData = {
            stats: {
                new: 0,
                removed: 1,
                modified: 1,
                total: 13
            },
            patientName: "MARIA DOLORES",
            comparisonInfo: "PRUEBA1.pdf vs PRUEBA2.pdf",
            file1: "PRUEBA1.pdf",
            file2: "PRUEBA2.pdf",
            changes: {
                new: [],
                removed: [
                    {
                        medication: "PARACETAMOL 1GR",
                        lastDetails: {
                            "Pauta": "1-1-1",
                            "Horario": "Desayuno, Comida, Cena"
                        }
                    }
                ],
                dosage: [],
                observation: [
                    {
                        medication: "APIXABAN 5 MG",
                        observation: "SE RETIRA X 10 D√çAS HATA EL 2 JUNIO"
                    }
                ]
            }
        };

        // Cargar datos de ejemplo al iniciar
        window.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => {
                loadComparisonData(exampleData);
            }, 1000);
        });

        // Escuchar mensajes desde n8n
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'comparisonData') {
                loadComparisonData(event.data.data);
            }
        });

        // Funci√≥n para descargar el informe en PDF
        function downloadPDF() {
            if (!currentData) {
                alert('No hay datos para generar el informe');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Configuraci√≥n de fuentes y colores
            const primaryColor = [102, 126, 234];
            const textColor = [51, 51, 51];
            const greenColor = [16, 185, 129];
            const redColor = [239, 68, 68];
            const blueColor = [59, 130, 246];
            const orangeColor = [245, 158, 11];
            
            // M√°rgenes
            const margin = 20;
            const pageWidth = doc.internal.pageSize.width;
            const contentWidth = pageWidth - 2 * margin;
            let yPosition = margin;
            
            // T√≠tulo principal
            doc.setFontSize(20);
            doc.setTextColor(...primaryColor);
            doc.text('INFORME DE CAMBIOS EN MEDICACI√ìN', pageWidth / 2, yPosition, { align: 'center' });
            yPosition += 15;
            
            // Informaci√≥n del paciente y fecha
            doc.setFontSize(12);
            doc.setTextColor(...textColor);
            const patientName = currentData.patientName || 'No especificado';
            const date = new Date().toLocaleDateString('es-ES', { 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
            
            doc.setFont(undefined, 'bold');
            doc.text(`Paciente: ${patientName}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Fecha: ${date}`, margin, yPosition);
            yPosition += 7;
            doc.text(`Archivos comparados: ${currentData.file1 || 'PDF 1'} vs ${currentData.file2 || 'PDF 2'}`, margin, yPosition);
            yPosition += 15;
            
            // L√≠nea separadora
            doc.setDrawColor(...primaryColor);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            // Resumen de estad√≠sticas
            doc.setFont(undefined, 'bold');
            doc.setFontSize(14);
            doc.text('RESUMEN DE CAMBIOS', margin, yPosition);
            yPosition += 10;
            
            doc.setFont(undefined, 'normal');
            doc.setFontSize(11);
            const stats = currentData.stats;
            const changes = currentData.changes || {};
            
            // Estad√≠sticas con colores
            doc.setTextColor(...greenColor);
            doc.text(`‚Ä¢ Medicamentos nuevos: ${stats.new || 0}`, margin + 5, yPosition);
            yPosition += 7;
            
            doc.setTextColor(...redColor);
            doc.text(`‚Ä¢ Medicamentos eliminados: ${stats.removed || 0}`, margin + 5, yPosition);
            yPosition += 7;
            
            doc.setTextColor(...orangeColor);
            doc.text(`‚Ä¢ Observaciones a√±adidas: ${(changes.observation || []).length}`, margin + 5, yPosition);
            yPosition += 7;
            
            doc.setTextColor(...blueColor);
            doc.text(`‚Ä¢ Cambios de posolog√≠a: ${(changes.dosage || []).length}`, margin + 5, yPosition);
            yPosition += 15;
            
            // Detalle de cambios
            doc.setTextColor(...textColor);
            
            // Medicamentos nuevos
            if (changes.new && changes.new.length > 0) {
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.setTextColor(...greenColor);
                doc.text('MEDICAMENTOS NUEVOS', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.setTextColor(...textColor);
                
                changes.new.forEach(med => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`‚Ä¢ ${med.medication}`, margin + 5, yPosition);
                    yPosition += 6;
                    
                    if (med.details) {
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        const details = Object.entries(med.details)
                            .map(([key, value]) => `${key}: ${value}`)
                            .join(' | ');
                        
                        const lines = doc.splitTextToSize(details, contentWidth - 10);
                        lines.forEach(line => {
                            doc.text(line, margin + 10, yPosition);
                            yPosition += 5;
                        });
                    }
                    yPosition += 5;
                });
                yPosition += 5;
            }
            
            // Medicamentos eliminados
            if (changes.removed && changes.removed.length > 0) {
                if (yPosition > 230) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.setTextColor(...redColor);
                doc.text('MEDICAMENTOS ELIMINADOS', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.setTextColor(...textColor);
                
                changes.removed.forEach(med => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`‚Ä¢ ${med.medication}`, margin + 5, yPosition);
                    yPosition += 6;
                    
                    if (med.lastDetails) {
                        doc.setFont(undefined, 'normal');
                        doc.setFontSize(10);
                        const details = Object.entries(med.lastDetails)
                            .map(([key, value]) => `${key}: ${value}`)
                            .join(' | ');
                        
                        const lines = doc.splitTextToSize(details, contentWidth - 10);
                        lines.forEach(line => {
                            doc.text(line, margin + 10, yPosition);
                            yPosition += 5;
                        });
                    }
                    yPosition += 5;
                });
                yPosition += 5;
            }
            
            // Cambios de posolog√≠a
            if (changes.dosage && changes.dosage.length > 0) {
                if (yPosition > 230) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.setTextColor(...blueColor);
                doc.text('CAMBIOS DE POSOLOG√çA', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.setTextColor(...textColor);
                
                changes.dosage.forEach(change => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`‚Ä¢ ${change.medication}`, margin + 5, yPosition);
                    yPosition += 6;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    const description = change.description || `Cambio de ${change.before} a ${change.after}`;
                    const lines = doc.splitTextToSize(description, contentWidth - 10);
                    lines.forEach(line => {
                        doc.text(line, margin + 10, yPosition);
                        yPosition += 5;
                    });
                    yPosition += 5;
                });
                yPosition += 5;
            }
            
            // Observaciones a√±adidas
            if (changes.observation && changes.observation.length > 0) {
                if (yPosition > 230) {
                    doc.addPage();
                    yPosition = margin;
                }
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(13);
                doc.setTextColor(...orangeColor);
                doc.text('OBSERVACIONES A√ëADIDAS', margin, yPosition);
                yPosition += 8;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(11);
                doc.setTextColor(...textColor);
                
                changes.observation.forEach(obs => {
                    if (yPosition > 250) {
                        doc.addPage();
                        yPosition = margin;
                    }
                    
                    doc.setFont(undefined, 'bold');
                    doc.text(`‚Ä¢ ${obs.medication}`, margin + 5, yPosition);
                    yPosition += 6;
                    
                    doc.setFont(undefined, 'italic');
                    doc.setFontSize(10);
                    const obsLines = doc.splitTextToSize(`"${obs.observation}"`, contentWidth - 10);
                    obsLines.forEach(line => {
                        doc.text(line, margin + 10, yPosition);
                        yPosition += 5;
                    });
                    yPosition += 5;
                });
            }
            
            // Nota final
            if (yPosition > 230) {
                doc.addPage();
                yPosition = margin;
            }
            
            yPosition += 10;
            doc.setDrawColor(...primaryColor);
            doc.setLineWidth(0.5);
            doc.line(margin, yPosition, pageWidth - margin, yPosition);
            yPosition += 10;
            
            doc.setFont(undefined, 'italic');
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            const nota = 'Este informe ha sido generado autom√°ticamente mediante la comparaci√≥n de los informes de medicaci√≥n. Se recomienda revisar los cambios con el personal m√©dico responsable.';
            const notaLines = doc.splitTextToSize(nota, contentWidth);
            notaLines.forEach(line => {
                doc.text(line, margin, yPosition);
                yPosition += 5;
            });
            
            // Descargar el PDF
            const fileName = `Informe_Cambios_${patientName.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
            doc.save(fileName);
        }
    </script>
</body>
</html>